package com.viplearner.api.services

import com.viplearner.api.client.ApiContext
import com.viplearner.api.client.BaseApiClient
import com.viplearner.api.client.BaseApiClient.Companion.json
import com.viplearner.api.client.LichessClient
import com.viplearner.api.client.auth.NoAuthProvider
import com.viplearner.api.models.ApiStreamEvent
import com.viplearner.api.models.BoardSeekRequest
import io.ktor.client.HttpClient
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.http.ContentType
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpMethod
import io.ktor.http.HttpStatusCode
import io.ktor.http.headersOf
import io.ktor.serialization.kotlinx.json.json
import io.ktor.utils.io.ByteReadChannel
import kotlinx.coroutines.CompletableDeferred
import kotlinx.coroutines.joinAll
import kotlinx.coroutines.launch
import kotlinx.coroutines.test.runTest
import kotlinx.serialization.json.Json
import kotlin.test.BeforeTest
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

/**
 * Generated test file for BoardService
 *
 * This file was automatically generated by the test generator script.
 * It contains tests for all API endpoints in the BoardService service.
 *
 * Tests use MockEngine to simulate HTTP responses and verify requests.
 */
class BoardServiceTest {
    @BeforeTest
    fun setup() {
        // Setup will be customized per test with mock engine
    }

    @Test
    fun testStreameventNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: GET api/stream/event
        // Service method: BoardService.streamEvent()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardseekCorrespondence_example0() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "gwkzmEBY"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/board/seek
                    assertEquals("api/board/seek", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act - Create correspondence seek request
            val seekRequest =
                com.viplearner.api.models.BoardSeekRequest.Correspondence(
                    days = 3,
                    rated = true,
                    variant = com.viplearner.api.models.VariantKey.STANDARD,
                )
            val result = testService.boardSeekCorrespondence(seekRequest)

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardseekRealTime_example1() {
        // Arrange - Mock HTTP response (empty NDJSON stream)
        val mockResponse = ""

        val mockEngine =
            MockEngine { request ->
                // Verify request matches expected endpoint: POST api/board/seek
                assertEquals("api/board/seek", request.url.encodedPath.trimStart('/'))
                assertEquals(HttpMethod.parse("POST"), request.method)

                // Verify form-urlencoded content type
                assertEquals(ContentType.Application.FormUrlEncoded.toString(), request.body.contentType.toString())

                // Verify Accept header for NDJSON
                assertEquals("application/x-ndjson", request.headers["Accept"])

                respond(
                    content = ByteReadChannel(mockResponse),
                    status = HttpStatusCode.fromValue(200),
                    headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                )
            }

        // Create mock HttpClient with proper configuration
        val mockHttpClient =
            HttpClient(mockEngine) {
                install(ContentNegotiation) {
                    json(
                        Json {
                            ignoreUnknownKeys = true
                            coerceInputValues = true
                            explicitNulls = false
                        },
                    )
                }
            }

        // Create service with mocked client
        val testApiClient =
            BaseApiClient(
                ctx =
                    ApiContext(
                        baseUrl = "https://lichess.org",
                        httpClient = mockHttpClient,
                        authProvider = NoAuthProvider(),
                    ),
            )
        val testService = BoardService(testApiClient)

        // Act - Create real-time seek request
        val seekRequest =
            com.viplearner.api.models.BoardSeekRequest.RealTime(
                time = 10.0,
                increment = 5,
                rated = false,
                color = com.viplearner.api.models.ChallengeColor.RANDOM,
            )
        val result = testService.boardSeekRealTime(seekRequest)

        // Assert
        assertTrue(result.isSuccess, "API call should succeed")
        val flow = result.getOrNull()
        assertNotNull(flow, "Flow should not be null")
        // Note: The flow is empty in this case, as per the API spec

        // Cleanup
        testApiClient.close()
    }

    @Test
    fun testBoardgamestream_oneOf_variant_0() =
        runTest {
            val gameId = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "BEOucQJo",
                            "variant": {
                                        "key": "standard",
                                        "name": "Standard",
                                        "short": "Std"
                            },
                            "speed": "rapid",
                            "perf": {
                                        "name": "Rapid"
                            },
                            "rated": false,
                            "createdAt": 1745112707998,
                            "white": {
                                        "id": "bobby",
                                        "name": "Bobby",
                                        "title": null,
                                        "rating": 1751
                            },
                            "black": {
                                        "id": "mary",
                                        "name": "Mary",
                                        "title": null,
                                        "rating": 1021
                            },
                            "initialFen": "startpos",
                            "clock": {
                                        "initial": 900000,
                                        "increment": 0
                            },
                            "type": "gameFull",
                            "state": {
                                        "type": "gameState",
                                        "moves": "d2d3",
                                        "wtime": 900000,
                                        "btime": 900000,
                                        "winc": 0,
                                        "binc": 0,
                                        "status": "started"
                            }
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/board/game/stream/${gameId}
                    assertEquals("api/board/game/stream/$gameId", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act
            val result = testService.boardGameStream(gameId = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: variant
            // Verify field: speed

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardgamestream_oneOf_variant_1() =
        runTest {
            val gameId = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "type": "gameState",
                            "moves": "e2e4 c7c5 f2f4 d7d6 g1f3 b8c6 f1c4 g8f6 d2d3 g7g6 e1g1 f8g7 b1c3",
                            "wtime": 7598040,
                            "btime": 8395220,
                            "winc": 10000,
                            "binc": 10000,
                            "wdraw": false,
                            "bdraw": false,
                            "wtakeback": false,
                            "btakeback": false,
                            "status": "started"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/board/game/stream/${gameId}
                    assertEquals("api/board/game/stream/$gameId", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act
            val result = testService.boardGameStream(gameId = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: type
            // Verify field: moves
            // Verify field: wtime

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardgamestream_oneOf_variant_2() =
        runTest {
            val gameId = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "type": "chatLine",
                            "username": "thibault",
                            "text": "Good luck, have fun",
                            "room": "player"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/board/game/stream/${gameId}
                    assertEquals("api/board/game/stream/$gameId", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act
            val result = testService.boardGameStream(gameId = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: type
            // Verify field: username
            // Verify field: text

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardgamestream_oneOf_variant_3() =
        runTest {
            val gameId = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "type": "opponentGone",
                            "gone": true,
                            "claimWinInSeconds": 8
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/board/game/stream/${gameId}
                    assertEquals("api/board/game/stream/$gameId", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act
            val result = testService.boardGameStream(gameId = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: type
            // Verify field: gone
            // Verify field: claimWinInSeconds

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardgamemoveNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/move/${move}
        // Service method: BoardService.boardGameMove()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgamechatpostNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/{gameId}/chat
        // Service method: BoardService.boardGameChatPost()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgamechatget() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                [
                            {
                                        "text": "Takeback sent",
                                        "user": "lichess"
                            },
                            {
                                        "text": "Takeback accepted",
                                        "user": "lichess"
                            },
                            {
                                        "text": "Good game, well played",
                                        "user": "thibault"
                            }
                ]
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/board/game/{gameId}/chat
                    assertEquals("api/board/game/{gameId}/chat", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = BoardService(testApiClient)

            // Act
            val result = testService.boardGameChatGet()

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Add specific field assertions here

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBoardgameabortNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/abort
        // Service method: BoardService.boardGameAbort()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgameresignNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/resign
        // Service method: BoardService.boardGameResign()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgamedrawNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/draw/${accept}
        // Service method: BoardService.boardGameDraw()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgametakebackNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/takeback/${accept}
        // Service method: BoardService.boardGameTakeback()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgameclaimvictoryNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/claim-victory
        // Service method: BoardService.boardGameClaimVictory()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgameclaimdrawNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/claim-draw
        // Service method: BoardService.boardGameClaimDraw()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testBoardgameberserkNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/board/game/${gameId}/berserk
        // Service method: BoardService.boardGameBerserk()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    // integration test
    @Test
    fun testStreamLiveGame() =
        runTest {
            val client = LichessClient.withToken("lip_0C5vEtdJA4qMC9wBifsK")

            println(client.account.accountMe())

            val gameId = CompletableDeferred<String>()

            val eventJob =
                backgroundScope.launch {
                    client.board.streamEvent()
                        .getOrElse { error("Failed to stream events: $it") }
                        .collect { event ->
                            println("Event: $event")
                            if (event is ApiStreamEvent.GameStartEvent) {
                                gameId.complete(event.game.gameId)
                            }
                        }
                    println("Event stream CLOSED by Lichess")
                }

            val seekJob =
                backgroundScope.launch {
                    client.board.boardSeekRealTime(
                        BoardSeekRequest.RealTime(
                            time = 15.0,
                            increment = 10,
                            rated = false,
                        ),
                    )
                        .getOrElse { error("Failed to create seek: $it") }
                        .collect { seekEvent ->
                            println("Seek event: $seekEvent")
                        }
                    println("Seek stream CLOSED by Lichess")
                }

            val gameJob =
                backgroundScope.launch {
                    val id = gameId.await()
                    client.board.boardGameStream(id)
                        .getOrElse { error("Failed to stream game: $it") }
                        .collect { gameEvent ->
                            println("Game event: $gameEvent")
                        }
                    println("Game stream CLOSED by Lichess â€” GAME OVER")
                }

            joinAll(eventJob, seekJob, gameJob)

            println("ALL STREAMS COMPLETED NATURALLY")
        }
}
