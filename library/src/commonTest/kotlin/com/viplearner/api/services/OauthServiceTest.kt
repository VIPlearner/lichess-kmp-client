package com.viplearner.api.services

import com.viplearner.api.client.ApiContext
import com.viplearner.api.client.BaseApiClient
import com.viplearner.api.client.BaseApiClient.Companion.json
import com.viplearner.api.client.auth.NoAuthProvider
import io.ktor.client.HttpClient
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpMethod
import io.ktor.http.HttpStatusCode
import io.ktor.http.headersOf
import io.ktor.serialization.kotlinx.json.json
import io.ktor.utils.io.ByteReadChannel
import kotlinx.coroutines.test.runTest
import kotlinx.serialization.json.Json
import kotlin.test.BeforeTest
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertTrue

/**
 * Generated test file for OauthService
 *
 * This file was automatically generated by the test generator script.
 * It contains tests for all API endpoints in the OauthService service.
 *
 * Tests use MockEngine to simulate HTTP responses and verify requests.
 */
class OauthServiceTest {
    @BeforeTest
    fun setup() {
        // Setup will be customized per test with mock engine
    }

    @Test
    fun testOauthNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: GET oauth
        // Service method: OauthService.oauth()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testTokenNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/token
        // Service method: OauthService.token()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testTokendeleteNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: DELETE api/token
        // Service method: OauthService.tokenDelete()
        // This test is skipped until examples are available in the OpenAPI specification
    }

    @Test
    fun testTokentest() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "lip_jose": {
                                        "userId": "jose",
                                        "scopes": "preference:read,preference:write,email:read,challenge:read,challenge:write,challenge:bulk,study:read,study:write,tournament:write,racer:write,puzzle:read,puzzle:write,team:read,team:write,team:lead,follow:read,follow:write,msg:write,board:play,bot:play,engine:read,engine:write,web:login,web:mod",
                                        "expires": null
                            },
                            "lip_badToken": null
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/token/test
                    assertEquals("api/token/test", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = OauthService(testApiClient)

            // Act
            val result = testService.tokenTest(body = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: lip_jose
            // Verify field: lip_badToken

            // Cleanup
            testApiClient.close()
        }
}
