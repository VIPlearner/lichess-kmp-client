package com.viplearner.api.services

import com.viplearner.api.client.ApiContext
import com.viplearner.api.client.BaseApiClient
import com.viplearner.api.client.BaseApiClient.Companion.json
import com.viplearner.api.client.auth.NoAuthProvider
import com.viplearner.api.models.ExternalEngineRegistration
import io.ktor.client.HttpClient
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpMethod
import io.ktor.http.HttpStatusCode
import io.ktor.http.headersOf
import io.ktor.serialization.kotlinx.json.json
import io.ktor.utils.io.ByteReadChannel
import kotlinx.coroutines.test.runTest
import kotlinx.serialization.json.Json
import kotlin.random.Random
import kotlin.test.BeforeTest
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertTrue

/**
 * Generated test file for ExternalEngineService
 *
 * This file was automatically generated by the test generator script.
 * It contains tests for all API endpoints in the ExternalEngineService service.
 *
 * Tests use MockEngine to simulate HTTP responses and verify requests.
 */
class ExternalEngineServiceTest {
    @BeforeTest
    fun setup() {
        // Setup will be customized per test with mock engine
    }

    @Test
    fun testExternalenginelist() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                [
                            {
                                        "id": "eei_yQo4LaPVD1ai",
                                        "name": "Stockfish 17",
                                        "userId": "bobby",
                                        "maxThreads": 8,
                                        "maxHash": 2048,
                                        "variants": [
                                                    "chess"
                                        ],
                                        "providerData": null,
                                        "clientSecret": "ees_LcUfwiqpVpRGwBez"
                            }
                ]
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/external-engine
                    assertEquals("api/external-engine", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result = testService.externalEngineList()

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Add specific field assertions here

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalenginecreate() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "eei_yQo4LaPVD1ai",
                            "name": "Stockfish 17",
                            "userId": "bobby",
                            "maxThreads": 8,
                            "maxHash": 2048,
                            "variants": [
                                        "chess"
                            ],
                            "providerData": null,
                            "clientSecret": "ees_LcUfwiqpVpRGwBez"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/external-engine
                    assertEquals("api/external-engine", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result =
                testService.externalEngineCreate(
                    body =
                        ExternalEngineRegistration(
                            name = "Test Engine ${Random.nextInt(1000, 9999)}",
                            maxThreads = 4,
                            maxHash = 1024,
                            providerSecret = "provider_secret_example",
                        ),
                )

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: name
            // Verify field: userId

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalengineget() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "eei_yQo4LaPVD1ai",
                            "name": "Stockfish 17",
                            "userId": "bobby",
                            "maxThreads": 8,
                            "maxHash": 2048,
                            "variants": [
                                        "chess"
                            ],
                            "providerData": null,
                            "clientSecret": "ees_LcUfwiqpVpRGwBez"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/external-engine/{id}
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result = testService.externalEngineGet(id = "mock_id")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: name
            // Verify field: userId

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalengineput() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "eei_yQo4LaPVD1ai",
                            "name": "Stockfish 17.1",
                            "userId": "bobby",
                            "maxThreads": 8,
                            "maxHash": 2048,
                            "variants": [
                                        "chess"
                            ],
                            "providerData": null,
                            "clientSecret": "ees_LcUfwiqpVpRGwBez"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: PUT api/external-engine/{id}
                    assertEquals(HttpMethod.parse("PUT"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result =
                testService.externalEnginePut(
                    id = "mock_id",
                    body =
                        ExternalEngineRegistration(
                            name = "Test Engine ${Random.nextInt(1000, 9999)}",
                            maxThreads = 4,
                            maxHash = 1024,
                            providerSecret = "provider_secret_example",
                        ),
                )

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: name
            // Verify field: userId

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalenginedelete() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "ok": true
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: DELETE api/external-engine/{id}
                    assertEquals(HttpMethod.parse("DELETE"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result = testService.externalEngineDelete(id = "mock_id")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: ok

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalengineanalyse() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "CNI9hZcXle9phmV5",
                            "work": {
                                        "sessionId": "1",
                                        "threads": 1,
                                        "hash": 2048,
                                        "depth": 1,
                                        "multiPv": 1,
                                        "variant": "chess",
                                        "initialFen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
                                        "moves": [
                                                    "e2e4",
                                                    "g8f6"
                                        ]
                            },
                            "engine": {
                                        "id": "eei_n7icubLdRJYm",
                                        "name": "Stockfish 17.1",
                                        "clientSecret": "ees_rR288clqHjNElDiP",
                                        "userId": "bobby",
                                        "maxThreads": 8,
                                        "maxHash": 2048,
                                        "variants": [
                                                    "chess"
                                        ],
                                        "providerData": null
                            }
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/external-engine/work
                    assertEquals("api/external-engine/work", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result = testService.externalEngineAnalyse(body = emptyMap())

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: work
            // Verify field: engine

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalengineacquire() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "CNI9hZcXle9phmV5",
                            "work": {
                                        "sessionId": "1",
                                        "threads": 1,
                                        "hash": 2048,
                                        "depth": 1,
                                        "multiPv": 1,
                                        "variant": "chess",
                                        "initialFen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
                                        "moves": [
                                                    "e2e4",
                                                    "g8f6"
                                        ]
                            },
                            "engine": {
                                        "id": "eei_n7icubLdRJYm",
                                        "name": "Stockfish 17.1",
                                        "clientSecret": "ees_rR288clqHjNElDiP",
                                        "userId": "bobby",
                                        "maxThreads": 8,
                                        "maxHash": 2048,
                                        "variants": [
                                                    "chess"
                                        ],
                                        "providerData": null
                            }
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/external-engine/work
                    assertEquals("api/external-engine/work", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = ExternalEngineService(testApiClient)

            // Act
            val result = testService.externalEngineAcquire(body = emptyMap())

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: work
            // Verify field: engine

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testExternalenginesubmitNotImplemented() {
        // TODO: No examples found in OpenAPI spec for this endpoint
        // Endpoint: POST api/external-engine/work/{id}
        // Service method: ExternalEngineService.externalEngineSubmit()
        // This test is skipped until examples are available in the OpenAPI specification
    }
}
