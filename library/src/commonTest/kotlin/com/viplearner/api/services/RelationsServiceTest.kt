package com.viplearner.api.services

import com.viplearner.api.client.ApiContext
import com.viplearner.api.client.BaseApiClient
import com.viplearner.api.client.BaseApiClient.Companion.json
import com.viplearner.api.client.auth.NoAuthProvider
import io.ktor.client.HttpClient
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpMethod
import io.ktor.http.HttpStatusCode
import io.ktor.http.headersOf
import io.ktor.serialization.kotlinx.json.json
import io.ktor.utils.io.ByteReadChannel
import kotlinx.coroutines.test.runTest
import kotlinx.serialization.json.Json
import kotlin.test.BeforeTest
import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertTrue

/**
 * Generated test file for RelationsService
 *
 * This file was automatically generated by the test generator script.
 * It contains tests for all API endpoints in the RelationsService service.
 *
 * Tests use MockEngine to simulate HTTP responses and verify requests.
 */
class RelationsServiceTest {
    @BeforeTest
    fun setup() {
        // Setup will be customized per test with mock engine
    }

    @Test
    fun testUserfollowing() =
        runTest {
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "id": "yaroslava",
                            "username": "Yaroslava",
                            "perfs": {
                                        "bullet": {
                                                    "games": 146,
                                                    "rating": 2175,
                                                    "rd": 51,
                                                    "prog": 17
                                        },
                                        "blitz": {
                                                    "games": 286,
                                                    "rating": 2204,
                                                    "rd": 47,
                                                    "prog": -49
                                        },
                                        "rapid": {
                                                    "games": 231,
                                                    "rating": 2259,
                                                    "rd": 102,
                                                    "prog": 20
                                        },
                                        "classical": {
                                                    "games": 201,
                                                    "rating": 2278,
                                                    "rd": 103,
                                                    "prog": 20
                                        },
                                        "correspondence": {
                                                    "games": 420,
                                                    "rating": 2296,
                                                    "rd": 102,
                                                    "prog": 36
                                        },
                                        "chess960": {
                                                    "games": 22,
                                                    "rating": 2231,
                                                    "rd": 50,
                                                    "prog": 36
                                        },
                                        "kingOfTheHill": {
                                                    "games": 37,
                                                    "rating": 2238,
                                                    "rd": 47,
                                                    "prog": 33
                                        },
                                        "threeCheck": {
                                                    "games": 405,
                                                    "rating": 2208,
                                                    "rd": 52,
                                                    "prog": 1
                                        },
                                        "antichess": {
                                                    "games": 114,
                                                    "rating": 2273,
                                                    "rd": 52,
                                                    "prog": -1
                                        },
                                        "atomic": {
                                                    "games": 248,
                                                    "rating": 2341,
                                                    "rd": 59,
                                                    "prog": 48
                                        },
                                        "horde": {
                                                    "games": 368,
                                                    "rating": 2222,
                                                    "rd": 45,
                                                    "prog": 26
                                        },
                                        "crazyhouse": {
                                                    "games": 109,
                                                    "rating": 2276,
                                                    "rd": 81,
                                                    "prog": 30
                                        },
                                        "puzzle": {
                                                    "games": 1470,
                                                    "rating": 2241,
                                                    "rd": 48,
                                                    "prog": -8
                                        }
                            },
                            "title": "FM",
                            "createdAt": 1751447947021,
                            "seenAt": 1752420698593,
                            "playTime": {
                                        "total": 19478,
                                        "tv": 0
                            },
                            "url": "https://lichess.org/@/Yaroslava"
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: GET api/rel/following
                    assertEquals("api/rel/following", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("GET"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/x-ndjson"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = RelationsService(testApiClient)

            // Act
            val result = testService.userFollowing()

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: id
            // Verify field: username
            // Verify field: perfs

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testFollowuser() =
        runTest {
            val username = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "ok": true
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/rel/follow/${username}
                    assertEquals("api/rel/follow/$username", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = RelationsService(testApiClient)

            // Act
            val result = testService.followUser(username = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: ok

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testUnfollowuser() =
        runTest {
            val username = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "ok": true
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/rel/unfollow/${username}
                    assertEquals("api/rel/unfollow/$username", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = RelationsService(testApiClient)

            // Act
            val result = testService.unfollowUser(username = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: ok

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testBlockuser() =
        runTest {
            val username = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "ok": true
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/rel/block/${username}
                    assertEquals("api/rel/block/$username", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = RelationsService(testApiClient)

            // Act
            val result = testService.blockUser(username = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: ok

            // Cleanup
            testApiClient.close()
        }

    @Test
    fun testUnblockuser() =
        runTest {
            val username = "mock"
            // Arrange - Mock HTTP response
            val mockResponse =
                """
                {
                            "ok": true
                }
                """.trimIndent()

            val mockEngine =
                MockEngine { request ->
                    // Verify request matches expected endpoint: POST api/rel/unblock/${username}
                    assertEquals("api/rel/unblock/$username", request.url.encodedPath.trimStart('/'))
                    assertEquals(HttpMethod.parse("POST"), request.method)

                    respond(
                        content = ByteReadChannel(mockResponse),
                        status = HttpStatusCode.fromValue(200),
                        headers = headersOf(HttpHeaders.ContentType, "application/json"),
                    )
                }

            // Create mock HttpClient with proper configuration
            val mockHttpClient =
                HttpClient(mockEngine) {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                coerceInputValues = true
                                explicitNulls = false
                            },
                        )
                    }
                }

            // Create service with mocked client
            val testApiClient =
                BaseApiClient(
                    ctx =
                        ApiContext(
                            baseUrl = "https://lichess.org",
                            httpClient = mockHttpClient,
                            authProvider = NoAuthProvider(),
                        ),
                )
            val testService = RelationsService(testApiClient)

            // Act
            val result = testService.unblockUser(username = "mock")

            // Assert
            assertTrue(result.isSuccess, "API call should succeed")

            // Verify field: ok

            // Cleanup
            testApiClient.close()
        }
}
